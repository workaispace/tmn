<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <title>Super Carry-Trade Simulator: Compact Pro</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root { --primary: #2b8cff; --success: #0b6; --danger: #e15759; --bg: #f8f9fa; --warn: #f28e2b; }
    body { font-family: 'Inter', system-ui, sans-serif; background: var(--bg); color: #111; margin: 0; padding: 20px; }
    .wrapper { max-width: 1200px; margin: 0 auto; }
    .grid-main { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    .card { background: #fff; border-radius: 12px; padding: 20px; border: 1px solid #e3e3e3; box-shadow: 0 4px 6px rgba(0,0,0,0.02); margin-bottom: 20px; }
    h2 { margin-top: 0; font-size: 18px; color: var(--primary); border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 15px; }
    .control-group { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
    label { font-size: 12px; font-weight: 600; color: #666; display: block; margin-bottom: 5px; }
    input[type="range"] { width: 100%; margin-bottom: 10px; }
    .val-display { font-size: 16px; font-weight: 700; color: var(--primary); }
    .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; }
    .kpi-item { padding: 10px; border-radius: 8px; border: 1px solid #eee; text-align: center; }
    .kpi-item span { display: block; font-size: 11px; text-transform: uppercase; color: #888; }
    .kpi-item div { font-size: 16px; font-weight: 800; }
    .status-ok { background: #e8ffe8; color: #1b5e20; }
    .status-bad { background: #ffe8e8; color: #b71c1c; }
    
    .gauge-container { width: 220px; margin: 0 auto; position: relative; }
    .gauge-label { position: absolute; bottom: 10px; left: 0; right: 0; text-align: center; font-size: 20px; font-weight: 800; }
    
    .heatmap-grid { display: grid; grid-template-columns: 80px repeat(5, 1fr); gap: 4px; margin-top: 15px; }
    .hm-cell { height: 45px; display: flex; align-items: center; justify-content: center; font-size: 11px; border-radius: 4px; color: #fff; font-weight: 700; }
    .hm-head { font-size: 11px; font-weight: 700; color: #888; text-align: center; display: flex; align-items: center; justify-content: center; }

    @media (max-width: 900px) { .grid-main { grid-template-columns: 1fr; } }
  </style>
</head>
<body>

<div class="wrapper">
  <h1>Pro Simulator: CNY Carry Trade & Margin</h1>

  <div class="grid-main">
    <div class="card">
      <h2>1. Параметры сделки</h2>
      <div class="control-group">
        <div>
          <label>Цель вывода (₽)</label>
          <div class="val-display" id="outS">100 000 000</div>
          <input id="S" type="range" min="1000000" max="500000000" step="1000000" value="100000000">
        </div>
        <div>
          <label>Срок сделки (дней)</label>
          <div class="val-display" id="outDays">365</div>
          <input id="days" type="range" min="1" max="365" step="1" value="365">
        </div>
        <div>
          <label>Курс входа (₽)</label>
          <div class="val-display" id="outBaseRate">11.34</div>
          <input id="baseRate" type="range" min="8" max="16" step="0.01" value="11.34">
        </div>
        <div>
          <label>Текущий курс (₽)</label>
          <div class="val-display" id="outCurrentRate">11.34</div>
          <input id="currentRate" type="range" min="8" max="20" step="0.01" value="11.34">
        </div>
      </div>

      <h2 style="margin-top:20px">2. Ставки и Риски</h2>
      <div class="control-group">
        <div>
          <label>Доходность AMNR (% год.)</label>
          <input id="rAmnr" type="number" value="16" step="0.1">
        </div>
        <div>
          <label>Ставка займа CNY (%)</label>
          <input id="rLoan" type="number" value="5" step="0.1">
        </div>
        <div>
          <label>Дисконт залога (dL %)</label>
          <input id="dL" type="number" value="15">
        </div>
        <div>
          <label>Дисконт шорта (dS %)</label>
          <input id="dS" type="number" value="30">
        </div>
      </div>
    </div>

    <div class="card">
      <h2>3. Обеспечение и Запас прочности</h2>
      <div class="kpi-grid">
        <div class="kpi-item"><span>Нужно в AMNR (НПР1)</span><div id="resNPR1">0</div></div>
        <div class="kpi-item"><span>Чистая прибыль</span><div id="resNet">0</div></div>
      </div>

      <div class="gauge-container" style="margin-top: 25px;">
        <canvas id="gaugeChart"></canvas>
        <div class="gauge-label" id="gaugeVal">0%</div>
      </div>
      
      <div id="marginStatus" class="kpi-item" style="margin-top:15px; font-weight:700;">
        Статус маржи: OK
      </div>
      
      <div style="margin-top:15px; font-size: 13px; color: #555; text-align: center;">
        Ликвидация при курсе: <b id="resMC">0</b> ₽ | Безубыточность: <b id="resBE">0</b> ₽
      </div>
    </div>
  </div>

  <div class="grid-main">
    <div class="card">
      <h2>4. Структура доходов и расходов (₽)</h2>
      <canvas id="barChart" height="200"></canvas>
    </div>

    <div class="card">
      <h2>5. Матрица прибыльности (Курс vs Дни, млн ₽)</h2>
      <div id="heatmap" class="heatmap-grid"></div>
    </div>
  </div>
</div>

<script>
const fmt = v => new Intl.NumberFormat('ru-RU', { maximumFractionDigits: 0 }).format(v);

let barChart, gaugeChart;

function initCharts() {
  const barCtx = document.getElementById('barChart').getContext('2d');
  barChart = new Chart(barCtx, {
    type: 'bar',
    data: {
      labels: ['Доход AMNR', 'Плата за займ', 'Валютный P/L', 'Чистый итог'],
      datasets: [{ data: [], backgroundColor: ['#4e79a7', '#f28e2b', '#e15759', '#59a14f'] }]
    },
    options: { plugins: { legend: { display: false } }, scales: { y: { beginAtZero: false } } }
  });

  const gaugeCtx = document.getElementById('gaugeChart').getContext('2d');
  gaugeChart = new Chart(gaugeCtx, {
    type: 'doughnut',
    data: {
      datasets: [{
        data: [0, 100],
        backgroundColor: ['#2b8cff', '#eee'],
        circumference: 180,
        rotation: 270,
        cutout: '80%'
      }]
    },
    options: { plugins: { legend: { display: false }, tooltip: { enabled: false } } }
  });
}

function update() {
  const S = parseFloat(document.getElementById('S').value);
  const days = parseFloat(document.getElementById('days').value);
  const X0 = parseFloat(document.getElementById('baseRate').value);
  const X_now = parseFloat(document.getElementById('currentRate').value);
  const rAmnr = parseFloat(document.getElementById('rAmnr').value) / 100;
  const rLoan = parseFloat(document.getElementById('rLoan').value) / 100;
  const dL = parseFloat(document.getElementById('dL').value) / 100;
  const dS = parseFloat(document.getElementById('dS').value) / 100;

  document.getElementById('outS').textContent = fmt(S);
  document.getElementById('outDays').textContent = days;
  document.getElementById('outBaseRate').textContent = X0;
  document.getElementById('outCurrentRate').textContent = X_now;

  const coefNPR1 = (1 + dS) / (1 - dL);
  const L_NPR1 = S * coefNPR1;
  const t = days / 365;

  const calcProfit = (x, d) => {
    const timeT = d / 365;
    const inc = L_NPR1 * rAmnr * timeT;
    const cost = S * rLoan * (x / X0) * timeT;
    const fx = S * (1 - (x / X0));
    return inc - cost + fx;
  };

  const netProfit = calcProfit(X_now, days);
  const X_be = X0 * ( (L_NPR1 * rAmnr * t + S) / (S * (1 + rLoan * t)) );
  const X_mc = X0 * (L_NPR1 * (1 - 0.5 * dL)) / (S * (1 + 0.5 * dS));

  document.getElementById('resNPR1').textContent = fmt(L_NPR1) + ' ₽';
  document.getElementById('resNet').textContent = fmt(netProfit) + ' ₽';
  document.getElementById('resNet').style.color = netProfit >= 0 ? 'var(--success)' : 'var(--danger)';
  document.getElementById('resBE').textContent = X_be.toFixed(2);
  document.getElementById('resMC').textContent = X_mc.toFixed(2);

  // Спидометр
  const safety = Math.max(0, Math.min(100, ((X_mc - X_now) / X_now) * 100));
  gaugeChart.data.datasets[0].data = [safety, 100 - safety];
  gaugeChart.data.datasets[0].backgroundColor = [safety < 5 ? 'var(--danger)' : 'var(--primary)', '#eee'];
  gaugeChart.update();
  document.getElementById('gaugeVal').textContent = safety.toFixed(1) + '%';

  const statusEl = document.getElementById('marginStatus');
  if (X_now >= X_mc) {
    statusEl.textContent = "МАРЖИН-КОЛЛ!";
    statusEl.className = "kpi-item status-bad";
  } else {
    statusEl.textContent = "СТАТУС МАРЖИ: OK";
    statusEl.className = "kpi-item status-ok";
  }

  // Столбчатый график
  const incAmnrNow = L_NPR1 * rAmnr * t;
  const costLoanNow = S * rLoan * (X_now / X0) * t;
  const fxPLNow = S * (1 - (X_now / X0));
  barChart.data.datasets[0].data = [incAmnrNow, -costLoanNow, fxPLNow, netProfit];
  barChart.update();

  // Тепловая карта
  const hm = document.getElementById('heatmap');
  hm.innerHTML = '';
  const hDays = [30, 90, 180, 270, 365];
  const hRates = [X0*0.9, X0, X0*1.1, X0*1.2, X0*1.3];
  
  hm.appendChild(document.createElement('div'));
  hDays.forEach(d => { 
    const div = document.createElement('div'); div.className='hm-head'; div.textContent=d+' дн.'; hm.appendChild(div); 
  });
  
  hRates.forEach(r => {
    const rDiv = document.createElement('div'); rDiv.className='hm-head'; rDiv.textContent=r.toFixed(2); hm.appendChild(rDiv);
    hDays.forEach(d => {
      const p = calcProfit(r, d);
      const cell = document.createElement('div');
      cell.className = 'hm-cell';
      const intensity = Math.min(Math.abs(p) / (S * 0.25), 1);
      cell.style.background = p >= 0 ? `rgba(0,180,0,${0.3+intensity})` : `rgba(220,0,0,${0.3+intensity})`;
      cell.textContent = (p/1000000).toFixed(0)+'M';
      hm.appendChild(cell);
    });
  });
}

document.querySelectorAll('input').forEach(i => i.oninput = update);
initCharts();
update();
</script>

</body>
</html>
